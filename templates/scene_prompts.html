<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シーンプロンプト | 官能小説ジェネレーター</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .prompts-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-top: 20px;
        }
        
        .prompts-content {
            white-space: pre-wrap;
            font-family: 'Noto Sans JP', sans-serif;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .prompts-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .scene-section {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .scene-section h2 {
            color: #e91e63;
            margin-bottom: 15px;
        }
        
        .scene-section h3 {
            color: #333;
            margin: 15px 0 10px;
            font-size: 1.1em;
        }
        
        .prompt-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 3px solid #e91e63;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .copy-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            float: right;
        }
        
        .copy-button:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>生成されたシーンプロンプト</h1>
            <nav>
                <a href="{{ url_for('index') }}">ホーム</a>
                <a href="{{ url_for('setting') }}">設定に戻る</a>
                <a href="{{ url_for('synopsis') }}">あらすじに戻る</a>
                <a href="{{ url_for('story') }}">小説に戻る</a>
            </nav>
        </header>
        
        <main>
            <section>
                <h2>Stable Diffusion用プロンプト</h2>
                <p>以下のプロンプトをStable Diffusionに入力して、シーンに合った画像を生成できます。</p>
                
                <div class="prompts-container" id="prompts-formatted">
                    <!-- JavaScriptで整形されたプロンプトがここに表示される -->
                </div>
                
                <div class="prompts-actions">
                    <button id="savePrompts" class="btn-secondary">プロンプトを保存</button>
                    <a href="{{ url_for('story') }}" class="btn-primary">小説に戻る</a>
                </div>
            </section>
        </main>
        
        <footer>
            <p>&copy; 2025 官能小説ジェネレーター</p>
        </footer>
    </div>
    
    <script>
        // 生のプロンプトテキスト
        const rawPromptsText = `{{ prompts_text|safe }}`;
        
        // プロンプトを整形して表示
        function formatPrompts() {
            const container = document.getElementById('prompts-formatted');
            
            // マークダウン形式のシーンセクションを解析
            const sceneRegex = /# シーン(\d+)/g;
            const sectionRegex = /## ([^\n]+)\n([^#]+)/g;
            
            let formattedHtml = '';
            let sceneMatch;
            let lastIndex = 0;
            
            // 各シーンを処理
            while ((sceneMatch = sceneRegex.exec(rawPromptsText)) !== null) {
                const sceneNum = sceneMatch[1];
                const sceneStart = sceneMatch.index;
                let sceneEnd;
                
                // 次のシーンの開始位置を探す
                const nextSceneMatch = rawPromptsText.indexOf(`# シーン`, sceneStart + 1);
                if (nextSceneMatch !== -1) {
                    sceneEnd = nextSceneMatch;
                } else {
                    sceneEnd = rawPromptsText.length;
                }
                
                const sceneContent = rawPromptsText.substring(sceneStart, sceneEnd);
                
                // シーンのHTML開始
                formattedHtml += `<div class="scene-section" id="scene-${sceneNum}">`;
                formattedHtml += `<h2>シーン ${sceneNum}</h2>`;
                
                // セクションを処理
                let sectionMatch;
                const sectionRegex = /## ([^\n]+)\n([^#]+)/g;
                
                while ((sectionMatch = sectionRegex.exec(sceneContent)) !== null) {
                    const sectionTitle = sectionMatch[1].trim();
                    const sectionContent = sectionMatch[2].trim();
                    
                    formattedHtml += `<h3>${sectionTitle}</h3>`;
                    
                    // SD用プロンプトは特別なスタイルで表示
                    if (sectionTitle.includes('プロンプト')) {
                        formattedHtml += `
                            <div class="prompt-container">
                                <button class="copy-button" data-content="${encodeURIComponent(sectionContent)}">コピー</button>
                                <div class="prompt-box">${sectionContent}</div>
                            </div>`;
                    } else {
                        formattedHtml += `<p>${sectionContent}</p>`;
                    }
                }
                
                // シーンのHTML終了
                formattedHtml += `</div>`;
            }
            
            // 何も一致しなかった場合
            if (formattedHtml === '') {
                formattedHtml = `<pre class="prompts-content">${rawPromptsText}</pre>`;
            }
            
            container.innerHTML = formattedHtml;
            
            // コピーボタンのイベントリスナー
            document.querySelectorAll('.copy-button').forEach(button => {
                button.addEventListener('click', function() {
                    const content = decodeURIComponent(this.getAttribute('data-content'));
                    navigator.clipboard.writeText(content).then(() => {
                        const originalText = this.textContent;
                        this.textContent = 'コピー完了!';
                        setTimeout(() => {
                            this.textContent = originalText;
                        }, 2000);
                    });
                });
            });
        }
        
        // 保存ボタンのイベントリスナー
        document.getElementById('savePrompts').addEventListener('click', function() {
            const blob = new Blob([rawPromptsText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sd_scene_prompts.txt';
            a.click();
            
            URL.revokeObjectURL(url);
        });
        
        // ページ読み込み時にプロンプトを整形
        document.addEventListener('DOMContentLoaded', formatPrompts);
    </script>
</body>
</html>